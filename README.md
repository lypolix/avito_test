# PR Service

Сервис для автоматического назначения ревьюверов на PR с управлением командами и пользователями.

---

## Технологии и подходы

**Используемые технологии:**
- Go — основной язык разработки  
- PostgreSQL — база данных  
- Gin — HTTP фреймворк  
- Docker & Docker Compose — контейнеризация  
- golang-migrate — миграции базы данных  

**Архитектурные паттерны и практики:**
- Clean Architecture — разделение на слои (handlers, services, repository)  
- Repository Pattern — абстракция доступа к данным  
- Принцип Single Responsibility
- Graceful Shutdown: корректный graceful shutdown с таймаутом
- Dependency Injection — инъекция зависимостей через конструкторы  
- REST API — соответствие RESTful принципам  
- Transaction Management — управление транзакциями в БД  
- Error Handling — кастомные бизнес-ошибки с кодами  
- Предотвращение утечек ресурсов: 
  - Connection pooling - настройка максимального количества соединений с БД
  - Таймауты - установка таймаутов для HTTP запросов и БД
  - Закрытие ресурсов - корректное закрытие соединений и транзакций
- Изолированная тестовая БД: а также автоматическая очистка
- Индексы в БД для быстрого поиска 

---

## Функциональность

**Основная функциональность:**
-  Создание и управление командами  
-  Управление пользователями (активность)  
-  Создание PR с автоматическим назначением ревьюверов  
-  Слияние PR (идемпотентная операция)  
-  Переназначение ревьюверов  
-  Получение PR пользователя как ревьювера  

**Дополнительная функциональность:**
-  Эндпоинт статистики  
-  Нагрузочное тестирование  
-  Метод массовой деактивации пользователей  
-  Интеграционные и E2E тесты  
-  Конфигурация линтера  

---


## Нагрузочное тестирование

**Реализованные профили:**
- Smoke — базовые проверки здоровья системы  
- Baseline — стандартная нагрузка с основными операциями  
- Mass — интенсивная нагрузка с массовыми операциями  

**Технологии и подходы:**
- Кастомный loadtest на Go  
- Контроль RPS — регулировка количества запросов в секунду  
- Виртуальные пользователи — эмуляция параллельных пользователей  
- Период прогрева — исключение метрик при старте  
- Сбор P50, P95, P99 времени ответа  

**Замеряемые характеристики:**
- Время ответа (P50, P95, P99, среднее, мин/макс)  
- Количество запросов и ошибок  
- Rate ошибок  
- Статус коды по эндпоинтам (2xx, 4xx, 5xx)  

**Результаты тестирования:**
- Сохраняются в `loadtest/results/` в формате JSON  
- Включают метрики, статистику по эндпоинтам и информацию о профиле  

---

## Тестирование

**End-to-End тесты:**
- Отдельный тестовый сервер (`docker-compose.test.yml`)  
- Изолированная БД PostgreSQL  
- Полные сценарии: от создания команды до мержа PR  
- Автоматическая очистка данных  

**Интеграционные тесты:**
- Проверка сервисного слоя и бизнес-логики  
- Проверка репозиториев и работы с БД  
- Моки базы данных  

**Пример E2E теста:**

TestFullPRWorkflow:
```
    // Создание команды
    // Создание PR с автоматическим назначением ревьюверов
    // Деактивация пользователя
    // Переназначение ревьювера
    // Слияние PR
    // Проверка статистики
```

---

## Массовая деактивация пользователей

**Реализация:**
- Транзакции для консистентности  
- Автоматическое переназначение ревьюверов  
- Время выполнения ≤ 100 мс для средних объемов  

**Пример запроса:**
```
POST http://localhost:8080/users/bulkDeactivate
Content-Type: application/json

{
  "team_name": "backend",
  "user_ids": ["user2", "user3"]
}
```

**Пример успешного ответа:**
```
HTTP/1.1 200 OK
Content-Type: application/json

{
  "team_name": "backend",
  "deactivated_users": ["user2", "user3"],
  "reassigned_prs": [
    {
      "pull_request_id": "pr-1001",
      "replacements": [
        {
          "old_user_id": "user2",
          "new_user_id": "user4"
        }
      ]
    }
  ],
  "failed_reassignments": []
}
```

**Как это работает:**
1. Получает список пользователей для деактивации.  
2. В транзакции деактивирует пользователей.  
3. Для каждого открытого PR ищет активную замену.  
4. Обновляет ревьюверов PR.  
5. Возвращает отчет о проделанных операциях.  

---

## Эндпоинт статистики

**Доступная статистика:**
- Статистика пользователей  
- Статистика PR  
- Общая сводка  

**Пример запроса:**
```
GET http://localhost:8080/stats
```

**Пример ответа:**
```
HTTP/1.1 200 OK
Content-Type: application/json

{
  "user_stats": [
    {
      "user_id": "user2",
      "username": "Bob",
      "team_name": "backend",
      "is_active": true,
      "assignments_count": 5
    }
  ],
  "pr_stats": [
    {
      "pull_request_id": "pr-1001",
      "pull_request_name": "Add search",
      "author_id": "user1",
      "status": "MERGED",
      "reviewers_count": 2,
      "team_name": "backend"
    }
  ],
  "summary": {
    "total_users": 50,
    "total_prs": 25,
    "total_assignments": 45,
    "avg_reviewers_per_pr": 1.8,
    "most_active_user": "user2",
    "most_reviewed_pr": "pr-1001"
  }
}
```

---

## Соответствие OpenAPI спецификации

Все обязательные эндпоинты реализованы  
Форматы запросов и ответов соответствуют спецификации  
Коды ошибок соответствуют  
HTTP статус-коды корректны  

---

## Конфигурация линтера

**Инструменты:**
- golangci-lint — основной линтер  
- Настройки указаны в `.golangci.yml`  


## Запуск

### Для docker compose:

```
make up
```
или 
```
docker compose up -d --build
```

### Для docker-compose:

```
make compose-up  
```
или
```
docker-compose up -d --build
```

### При необходимости создать .env файл (в Makefile это уже предусмотрено)
```
cp .env.example .env
```


## Доступ к базе данных (если нужно)

### Подключиться к БД внутри контейнера

```
docker compose exec db psql -U avito_user -d avito_db
```

### Или пробросить порт временно

```
docker compose exec -it db 
```

затем внутри:

```
psql -U avito_user -d avito_db
```

## Дополнительные команды

**Проверить статус**
```
make status
```

**Посмотреть логи**
```
make logs
```

## Запуск тестов 

### Интеграционные тесты
```
make test-integration
```

### E2E тесты
```
make test-e2e
```

### Все тесты сразу
```
make test-all
```

### Полный CI пайплайн
```
make ci
```

## Нагрузочное тестирование

### Запустить load test окружение
```
make load-up
```

### Запустить все нагрузочные тесты
```
make load-test-all
```

### Остановить load test окружение
```
make load-down
```

Load test сервис будет доступен по адресу: http://localhost:18080

## Линтер 

### Проверить форматирование и зависимости
```
make code-check
```

### Запустить линтер
```
make lint
```

**Требования:**
- Docker  
- Docker Compose  

Сервис будет доступен на [http://localhost:8080](http://localhost:8080)


# Вопросы и принятые решения

## 1. Создание PR неактивным пользователем

**Вопрос:**  
В спецификации не указано, может ли неактивный пользователь создавать Pull Request.

**Решение:**  
Разрешено создание PR неактивным пользователям, так как:  
- Основное ограничение касается назначения ревьюверов — только активные.  
- Логически создание PR — это действие, не требующее активности(или каких-то дополнительных прав) в команде.  
- Неактивность влияет только на участие в процессе ревью, но не на возможность инициировать PR.

---

## 2. Принадлежность пользователя к одной команде

**Вопрос:**  
Может ли пользователь состоять в нескольких командах одновременно и что делать, если при создании команды указывается пользователь, уже принадлежащий другой?

**Решение:**  
Пользователь может принадлежать только одной команде.  
При попытке добавить пользователя в новую команду, если он уже состоит в другой — возвращается ошибка с сообщением о конфликте членства.  

Обоснование:  
- Упрощает логику создания команды.  
- Исключает конфликты при переназначении ревьюверов.  
- Предотвращает удаление пользователя из команды, где он участвует как ревьювер.

---

## 3. Переназначение ревьювера с учетом автора

**Вопрос:**  
Спецификация требует переназначения на случайного активного участника команды, но не уточняет, можно ли назначать автора PR ревьювером.

**Решение:**  
Автор PR исключается из пула кандидатов на переназначение.  

Причины:  
- Автор не может ревьювить собственный PR.  
- Исключается конфликт интересов.  
- Повышается корректность и прозрачность ревью.
```
